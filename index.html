<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Private Tracker ‚Äî Kuwait Job</title>

<!-- Google font (optional) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1: #0f1724;
    --bg2: #0b1220;
    --card: rgba(255,255,255,0.06);
    --accent: #00AAFF; /* primary blue */
    --accent-2: #6a11cb;
    --muted: #9aa4b2;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin:0; min-height:100vh;
    background: linear-gradient(135deg, #071029 0%, #0b1b2e 100%);
    color: #e6eef8;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:24px;
  }

  .wrap{ max-width:900px; margin: 0 auto 140px; }

  header{ text-align:center; margin-bottom:18px; }
  h1{ margin:0; font-size:20px; color:var(--accent); letter-spacing:0.2px }
  .subtitle{ color:var(--muted); font-size:13px; margin-top:6px }

  /* main card */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    padding:18px;
    box-shadow: 0 8px 30px rgba(3,6,15,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }

  /* progress */
  .progress-row{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
  .progress-label{ font-size:13px; color:var(--muted) }
  .progress-bar {
    flex:1; height:16px; border-radius:10px; background:rgba(255,255,255,0.04); overflow:hidden;
    position:relative;
  }
  .progress-fill{
    height:100%; width:0%; background: linear-gradient(90deg,var(--accent), #0088CC);
    border-radius:10px; transition: width 500ms ease;
    display:flex; align-items:center; justify-content:center; color:#001; font-weight:600;
    font-size:12px;
  }

  /* timeline */
  .timeline{ position:relative; padding-left:56px; }
  .timeline::before{
    content:''; position:absolute; left:24px; top:12px; bottom:12px; width:4px; background:rgba(255,255,255,0.04); border-radius:4px;
  }
  /* fill line (blue) - height set by JS */
  .timeline .line-fill{ position:absolute; left:24px; top:12px; width:4px; background:linear-gradient(180deg,var(--accent),#006699); border-radius:4px; z-index:0; height:0%; }

  .step-card{
    position:relative; z-index:2;
    display:flex; align-items:flex-start; gap:12px; background:var(--card);
    padding:12px 14px; border-radius:10px; margin:18px 0;
    box-shadow: 0 6px 18px rgba(2,6,23,0.4);
    transition: transform 220ms ease, box-shadow 220ms ease, background 220ms;
  }
  .step-card .bubble{
    width:44px; height:44px; border-radius:10px; flex-shrink:0;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    display:flex; align-items:center; justify-content:center; font-size:18px;
    color: var(--accent);
    border:1px solid rgba(255,255,255,0.02);
  }
  .step-meta{ flex:1; }
  .step-title{ font-weight:600; margin:0 0 6px 0; font-size:15px; color:#eaf6ff; }
  .step-actions{ display:flex; gap:8px; align-items:center; }

  .note{ margin-top:8px; }
  .note input{ width:100%; padding:8px 10px; border-radius:8px; border: none; background: rgba(255,255,255,0.02); color: #dfe9f8; outline:none; font-size:14px }

  .btn-done{
    padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:rgba(0,170,255,0.95); color:#fff; font-weight:600;
    box-shadow: 0 6px 18px rgba(0,138,204,0.12);
  }
  .btn-done[disabled]{ opacity:0.55; cursor:default; filter:grayscale(0.1); }

  .step-completed{ background: linear-gradient(180deg, rgba(0,170,255,0.06), rgba(0,170,255,0.03)); border:1px solid rgba(0,170,255,0.08); }
  .completed .bubble{ background:linear-gradient(90deg,#00AAFF,#0088CC); color:#001; box-shadow: 0 6px 14px rgba(0,138,204,0.14) }

  /* small message toast */
  .toast {
    position:fixed; left:50%; transform:translateX(-50%); bottom:28px; z-index:1200;
    background: rgba(0,0,0,0.7); color:#fff; padding:12px 18px; border-radius:10px; font-weight:600;
    display:none; align-items:center; gap:10px; box-shadow: 0 8px 30px rgba(0,0,0,0.5);
  }

  /* popup full surprise */
  .popup {
    display:none; position:fixed; inset:0; background:rgba(2,6,23,0.85); z-index:2000;
    justify-content:center; align-items:center; padding:20px;
  }
  .popup .card{
    max-width:420px; width:100%; text-align:center; padding:24px; border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 10px 40px rgba(2,6,23,0.7);
  }
  .popup h2{ color:var(--accent); margin:0 0 8px 0; }
  .popup p{ color:#dbeeff; margin:0; font-size:15px; }

  .popup img{ width:140px; margin:18px 0; border-radius:8px; }

  .popup button{ margin-top:16px; padding:10px 16px; border-radius:8px; border:none; background:var(--accent); color:#001; font-weight:700; cursor:pointer; }

  /* chat toggle and box */
  #chat-toggle{
    position: fixed; bottom:22px; right:22px; z-index:1500;
    width:56px; height:56px; border-radius:50%; background:linear-gradient(180deg,var(--accent),#006699);
    display:flex; align-items:center; justify-content:center; color:#001; font-weight:800; font-size:20px; cursor:pointer;
    box-shadow: 0 12px 30px rgba(0,138,204,0.18);
    border: 2px solid rgba(255,255,255,0.06);
  }
  #chat-box{
    display:none; position:fixed; right:22px; bottom:92px; width:360px; z-index:1500;
    border-radius:12px; overflow:hidden; background:linear-gradient(180deg, #f8fbff, #eef8ff);
    color:#0b1b2e; box-shadow: 0 20px 50px rgba(3,6,15,0.6); border:1px solid rgba(0,0,0,0.06);
    min-height: 380px; max-height:70vh; display:flex; flex-direction:column;
  }
  #chat-header{ padding:12px 14px; background: linear-gradient(90deg,var(--accent), #006699); color:#001; display:flex; align-items:center; justify-content:space-between; font-weight:700; }
  #chat-messages{ padding:12px; flex:1; overflow:auto; background:linear-gradient(180deg,#fff,#f1faff); display:flex; flex-direction:column; gap:8px; }
  .msg { padding:8px 12px; border-radius:10px; max-width:80%; word-break:break-word; font-size:14px; }
  .mine { background:#00AAFF; color:#001; align-self:flex-end; box-shadow: 0 6px 14px rgba(0,138,204,0.12)}
  .theirs { background:#e0e8ff; color:#001; align-self:flex-start;}
  #chat-input-row{ display:flex; gap:8px; padding:10px; background:transparent; border-top:1px solid rgba(0,0,0,0.05); }
  #chat-input{ flex:1; padding:10px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); outline:none }
  #chat-send { padding:10px 12px; background:var(--accent); color:#001; border:none; border-radius:10px; cursor:pointer; }

  /* footer space so steps not hidden on small screens */
  .bottom-space { height:140px; }

  /* responsive */
  @media (max-width:480px){
    #chat-box{ right:12px; width:92%; bottom:80px; }
    .wrap{ padding:0 12px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Private Kuwait Job Tracker</h1>
    <div class="subtitle">Track steps, chat privately, and celebrate together ‚ù§Ô∏è</div>
  </header>

  <main class="card" id="main-card">
    <div class="progress-row">
      <div class="progress-label">Progress</div>
      <div class="progress-bar" aria-hidden="true">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div style="width:64px;text-align:right;color:var(--muted);font-size:13px" id="percentText">0%</div>
    </div>

    <section class="timeline" id="timeline">
      <div class="line-fill" id="lineFill"></div>
      <!-- Steps will be injected here by JS -->
    </section>

    <div style="text-align:center;margin-top:12px">
      <button id="resetBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer">Reset Progress</button>
    </div>
  </main>

  <div class="bottom-space"></div>
</div>

<!-- toast -->
<div class="toast" id="toast"></div>

<!-- surprise popup -->
<div class="popup" id="popup">
  <div class="card">
    <h2>üéâ Congratulations! üéâ</h2>
    <p id="popupText">You completed all steps ‚Äî special surprise!</p>
    <img src="https://media.giphy.com/media/111ebonMs90YLu/giphy.gif" alt="celebrate" />
    <div><button id="popupClose">Yayy!</button></div>
  </div>
</div>

<!-- chat toggle and box -->
<div id="chat-toggle" title="Open chat">üí¨</div>

<div id="chat-box" aria-hidden="true">
  <div id="chat-header">
    <span>Private Chat</span>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="clearLocalChat" title="Clear local chat" style="border:none;background:transparent;cursor:pointer;color:#001;font-weight:700">CLR</button>
      <button id="closeChat" title="Close chat" style="border:none;background:transparent;cursor:pointer;color:#001;font-weight:700">‚úñ</button>
    </div>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input-row">
    <input id="chat-input" placeholder="Type a message..." />
    <button id="chat-send">Send</button>
  </div>
</div>

<!-- confetti lib -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- Firebase + app logic (module) -->
<script type="module">
  // ---- Firebase imports (v12 modules) ----
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  // ---- Your Firebase config (keep as-is or replace if you have different) ----
  const firebaseConfig = {
    apiKey: "AIzaSyAeaNbgbfnOX5i3B3TIlZ7uwLXK86dOOgo",
    authDomain: "private-tracker-85553.firebaseapp.com",
    projectId: "private-tracker-85553",
    storageBucket: "private-tracker-85553.firebasestorage.app",
    messagingSenderId: "542425150653",
    appId: "1:542425150653:web:76a2065694dfb155ca73d4"
    // Note: databaseURL is optional here; Realtime DB should be enabled in console
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---- App data: steps (icons + messages) ----
  const STEPS = [
    { icon:'üìù', title:'Prometric exam (MOH Kuwait)', hint:'Prometric exam complete! Keep going üí™' },
    { icon:'üìÑ', title:'Documents attestation', hint:'Documents attested! Great job üìÑ' },
    { icon:'‚úÖ', title:'Documents verification (QuadraBay)', hint:'Verification done! Almost there ‚úÖ' },
    { icon:'üíº', title:'Job offer', hint:'Job offer received! Woohoo üéâ' },
    { icon:'üõÇ', title:'Receive Visa', hint:'Visa received! üõÇ' },
    { icon:'‚úíÔ∏è', title:'Visa Stamping', hint:'Visa stamped! ‚úàÔ∏è' },
    { icon:'üè•', title:'Medical Test (Fit)', hint:'Medical test passed! üíä' },
    { icon:'‚úàÔ∏è', title:'Travel', hint:'Travel complete! Surprise incoming üéÅ' }
  ];

  // ---- DOM refs ----
  const timeline = document.getElementById('timeline');
  const progressFill = document.getElementById('progressFill');
  const percentText = document.getElementById('percentText');
  const lineFill = document.getElementById('lineFill');
  const toast = document.getElementById('toast');
  const popup = document.getElementById('popup');
  const popupClose = document.getElementById('popupClose');
  const popupText = document.getElementById('popupText');

  // Chat elements
  const chatToggle = document.getElementById('chat-toggle');
  const chatBox = document.getElementById('chat-box');
  const closeChat = document.getElementById('closeChat');
  const chatMessages = document.getElementById('chat-messages');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');
  const clearLocalChatBtn = document.getElementById('clearLocalChat');

  // Reset
  const resetBtn = document.getElementById('resetBtn');

  // local client id so we can mark our messages
  let CLIENT_ID = localStorage.getItem('pt_client_id');
  if(!CLIENT_ID){
    CLIENT_ID = 'c_'+Math.random().toString(36).slice(2,9);
    localStorage.setItem('pt_client_id', CLIENT_ID);
  }

  // ---- Render steps dynamically ----
  function renderSteps(){
    // remove existing step elements (except line-fill which is first child)
    // clear all child nodes except the line-fill (first child)
    Array.from(timeline.querySelectorAll('.step-card')).forEach(n=>n.remove());

    STEPS.forEach((s, idx) => {
      const card = document.createElement('div');
      card.className = 'step-card';
      card.id = 'step-'+idx;
      card.innerHTML = `
        <div class="bubble">${s.icon}</div>
        <div class="step-meta">
          <div class="step-title">${s.title}</div>
          <div class="note"><input data-step="${idx}" placeholder="Add note (optional)" /></div>
        </div>
        <div class="step-actions">
          <button class="btn-done" data-step="${idx}">Done</button>
        </div>
      `;
      timeline.appendChild(card);
    });
  }

  renderSteps();

  // ---- Load saved state (checkboxes & notes) ----
  function loadState(){
    STEPS.forEach((_,i) => {
      const done = localStorage.getItem('pt_step_'+i) === '1';
      const note = localStorage.getItem('pt_note_'+i) || '';
      const card = document.getElementById('step-'+i);
      const btn = card.querySelector('.btn-done');
      const noteInput = card.querySelector('input[data-step]');
      noteInput.value = note;
      if(done){
        card.classList.add('completed');
        btn.disabled = true;
      } else {
        btn.disabled = (i !== 0 && localStorage.getItem('pt_step_'+(i-1)) !== '1'); // lock until previous done
      }
    });
    updateProgressVisual();
  }

  // ---- Save note listeners ----
  timeline.addEventListener('input', (e)=>{
    const t = e.target;
    if(t.matches('input[data-step]')){
      const idx = t.getAttribute('data-step');
      localStorage.setItem('pt_note_'+idx, t.value);
    }
  });

  // ---- Done button handler ----
  timeline.addEventListener('click', (e)=>{
    const btn = e.target.closest('.btn-done');
    if(!btn) return;
    const idx = Number(btn.getAttribute('data-step'));
    markStepDone(idx);
  });

  function markStepDone(idx){
    // set local
    localStorage.setItem('pt_step_'+idx, '1');
    const card = document.getElementById('step-'+idx);
    card.classList.add('completed');
    card.querySelector('.btn-done').disabled = true;

    // unlock next
    if(idx+1 < STEPS.length){
      const nextBtn = document.querySelector('#step-'+(idx+1)+' .btn-done');
      if(nextBtn) nextBtn.disabled = false;
    }

    // show small hint (Hinglish / milestone)
    showToast(STEPS[idx].hint);

    // update progress visual & maybe surprise
    updateProgressVisual();
  }

  // ---- Progress visuals ----
  function updateProgressVisual(){
    const total = STEPS.length;
    let doneCount = 0;
    STEPS.forEach((_,i)=>{
      if(localStorage.getItem('pt_step_'+i) === '1') doneCount++;
    });
    const percent = Math.round((doneCount/total)*100);
    progressFill.style.width = percent + '%';
    progressFill.textContent = percent + '%';
    percentText.textContent = percent + '%';

    // update vertical line fill
    // compute timeline height available
    const tl = timeline;
    const topPadding = 12; // same as CSS top spacing
    const bottomPadding = 12;
    const height = tl.getBoundingClientRect().height - topPadding - bottomPadding;
    const fillPx = Math.max(0, Math.min(height, Math.round((percent/100)*height)));
    lineFill.style.height = fillPx + 'px';

    // milestone confetti and messages at specific thresholds (25,50,75,100)
    if([25,50,75].includes(percent) && lastShownMilestone !== percent){
      lastShownMilestone = percent;
      showToast(hinglishMessages[percent]);
      confetti({ particleCount: 90, spread: 70, origin: { y: 0.6 }});
    }
    if(percent === 100 && lastShownMilestone !== 100){
      lastShownMilestone = 100;
      // final surprise
      confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 }});
      popupText.textContent = "Yayy! Sab steps complete ‚Äî surprise for you ‚ù§Ô∏è";
      popup.style.display = 'flex';
    }
  }

  // Hinglish messages
  const hinglishMessages = {
    25: "Shabaash! Shuruaat achhi hai üòÉ",
    50: "Waah! Adha kaam ho gaya üèÜ",
    75: "Bas thoda aur! Almost there üí™",
    100: "Yayy! Sab steps complete ‚ù§Ô∏è Surprise ka time hai üéâ"
  };
  let lastShownMilestone = 0;

  function showToast(txt, duration=2500){
    toast.textContent = txt;
    toast.style.display = 'flex';
    setTimeout(()=>{ toast.style.display = 'none'; }, duration);
  }

  // popup close
  popupClose.addEventListener('click', ()=> popup.style.display = 'none');

  // Reset button
  resetBtn.addEventListener('click', ()=>{
    if(!confirm('Reset all progress and notes?')) return;
    STEPS.forEach((_,i)=>{
      localStorage.removeItem('pt_step_'+i);
      localStorage.removeItem('pt_note_'+i);
      const card = document.getElementById('step-'+i);
      card.classList.remove('completed');
      card.querySelector('.btn-done').disabled = (i !== 0);
      card.querySelector('input[data-step]').value = '';
    });
    lastShownMilestone = 0;
    updateProgressVisual();
  });

  // ---- Chat: toggle & UI ----
  chatToggle.addEventListener('click', ()=> {
    chatBox.style.display = 'flex';
    chatToggle.style.display = 'none';
    // load messages in view
  });
  closeChat.addEventListener('click', ()=> {
    chatBox.style.display = 'none';
    chatToggle.style.display = 'flex';
  });

  // clear local chat messages (client-side)
  clearLocalChatBtn.addEventListener('click', ()=>{
    if(confirm('Clear chat messages from this device?')) {
      chatMessages.innerHTML = '';
      localStorage.removeItem('pt_chat_local');
    }
  });

  // ---- Firebase chat wiring ----
  // Each message stored under /messages with fields { clientId, text (base64), ts }
  // Listen for new messages
  onChildAdded(ref(db, 'messages'), (snap) => {
    const m = snap.val();
    if(!m) return;
    const text = (() => { try { return atob(m.text); } catch(e){ return m.text; } })();
    appendChatMessage(text, m.clientId, new Date(m.ts || Date.now()));
  });

  // append chat msg to UI
  function appendChatMessage(text, senderId, time){
    const div = document.createElement('div');
    const mine = (senderId === CLIENT_ID);
    div.className = 'msg ' + (mine ? 'mine' : 'theirs');
    div.innerHTML = `<div style="font-size:13px;margin-bottom:6px">${text}</div><div style="font-size:11px;color:#6b7280;margin-top:6px">${formatTime(time)}</div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // store recent local chat (optional)
    saveChatLocally(text, senderId, time);
  }

  function formatTime(d){
    if(!d) return '';
    const dt = new Date(d);
    return dt.toLocaleString();
  }

  function saveChatLocally(text, senderId, time){
    try{
      const arr = JSON.parse(localStorage.getItem('pt_chat_local') || '[]');
      arr.push({text, senderId, ts: (time && time.getTime) ? time.getTime() : Date.now()});
      // keep only last 300 messages
      while(arr.length > 300) arr.shift();
      localStorage.setItem('pt_chat_local', JSON.stringify(arr));
    }catch(e){}
  }

  // load local chat history into UI (so at least past local messages visible quickly)
  (function loadLocalChat(){
    try{
      const arr = JSON.parse(localStorage.getItem('pt_chat_local') || '[]');
      arr.forEach(m=> appendChatMessage(m.text, m.senderId || 'other', new Date(m.ts || Date.now())));
    }catch(e){}
  })();

  // send chat on click or Enter
  chatSend.addEventListener('click', sendChat);
  chatInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter') sendChat(); });

  function sendChat(){
    const txt = chatInput.value.trim();
    if(!txt) return;
    const enc = btoa(txt); // note: base64 only; not true E2E
    const node = push(ref(db, 'messages'), { clientId: CLIENT_ID, text: enc, ts: Date.now() });
    chatInput.value = '';
  }

  // ---- init ----
  renderSteps();
  loadState();
  updateProgressVisual();

  // When page resizes, update the vertical line fill so it re-computes height
  window.addEventListener('resize', ()=> updateProgressVisual());

  // helper: show popup after final step (we already do that in updateProgressVisual)
  // You can also bind clicking completed step to show details
</script>
</body>
</html>
