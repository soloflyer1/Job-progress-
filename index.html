<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kuwait Job Tracker — Upgraded</title>

<!-- external libs -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<style>
  :root {
    --bg1:#071029; --bg2:#0b1b2e;
    --card: rgba(255,255,255,0.04);
    --accent: #00AAFF;
    --accent-dark:#006699;
    --muted:#9aa4b2;
    --light-bg: #f7fbff;
    --light-card: #ffffff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
    color: #e6f2ff;
  }
  .wrap{ max-width:980px; margin:20px auto; padding:18px; transition: padding-bottom .25s ease; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .title-left{ display:flex; flex-direction:column; }
  h1{ margin:0; color:var(--accent); font-size:20px; }
  .subtitle{ color:var(--muted); font-size:13px; margin-top:6px; }
  .controls-top{ display:flex; gap:8px; align-items:center; }
  .btn { padding:8px 10px; border-radius:8px; border:none; cursor:pointer; font-weight:700; background:linear-gradient(90deg,var(--accent),var(--accent-dark)); color:#001 }
  .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.03);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }

  .progress-row{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
  .progress-label{ font-size:13px; color:var(--muted); width:70px }
  .progress-bar { flex:1; height:20px; border-radius:12px; background:rgba(255,255,255,0.03); overflow:hidden; position:relative }
  .progress-fill { height:100%; width:0%; background: linear-gradient(90deg,var(--accent),var(--accent-dark)); display:flex; align-items:center; justify-content:center; color:#001; font-weight:700; font-size:12px; transition: width .8s cubic-bezier(.2,.9,.2,1); }
  .progress-meta { display:flex; gap:8px; align-items:center; font-size:12px; color:var(--muted); }

  .timeline{ position:relative; padding-left:64px; }
  .step{ position:relative; margin-bottom:30px; }
  .circle{ width:34px; height:34px; border-radius:50%; background:var(--card); border:2px solid var(--accent); display:flex; align-items:center; justify-content:center; font-size:16px; font-weight:bold; color:var(--accent); position:absolute; left:0; top:0; }
  .circle.done{ background:var(--accent); color:#001; }
  .circle.locked{ border-color:#444; color:#444; }
  .vline{ position:absolute; left:16px; top:36px; bottom:-30px; width:2px; background:var(--accent); transform:scaleY(0); transform-origin:top; transition:transform .7s ease; }
  .vline.filled{ transform:scaleY(1); }
  .step-content{ margin-left:60px; padding:12px 14px; background:var(--card); border-radius:8px; }
  .step h3{ margin:0 0 6px; font-size:15px; }
  .step input[type=checkbox]{ margin-right:6px; }

  textarea{ width:100%; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); background:rgba(0,0,0,0.2); color:#e6f2ff; min-height:50px; }
  textarea:disabled{ opacity:0.5; }

  #chatbox{ position:fixed; bottom:0; right:20px; width:320px; background:var(--card); border:1px solid rgba(255,255,255,0.08); border-radius:12px 12px 0 0; box-shadow:0 -2px 15px rgba(0,0,0,0.4); display:flex; flex-direction:column; max-height:70%; }
  #chatbox h2{ margin:0; padding:10px; background:var(--accent); color:#001; font-size:14px; }
  #messages{ flex:1; overflow-y:auto; padding:10px; font-size:14px; }
  .msg{ margin-bottom:8px; padding:6px 8px; border-radius:6px; max-width:80%; }
  .me{ background:rgba(0,170,255,0.2); align-self:flex-end; }
  .other{ background:rgba(255,255,255,0.1); align-self:flex-start; }
  .typing{ font-size:12px; color:var(--muted); margin:2px 0; }
  #chat-input{ display:flex; gap:4px; padding:8px; border-top:1px solid rgba(255,255,255,0.06); }
  #chat-input input{ flex:1; padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.08); }
  #chat-input button{ padding:6px 10px; }

  .dark{ background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#e6f2ff; }
  .light{ background:var(--light-bg); color:#111; }
  .light .card{ background:var(--light-card); color:#111; }
  .light h1{ color:var(--accent-dark); }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title-left">
      <h1>Kuwait Job Tracker — Upgraded</h1>
      <div class="subtitle">Private progress + chat</div>
    </div>
    <div class="controls-top">
      <button id="themeToggle" class="btn">Toggle Theme</button>
      <button id="exportCSV" class="btn">Export CSV</button>
      <button id="exportPDF" class="btn">Export PDF</button>
      <button id="reset" class="btn-ghost">Reset</button>
    </div>
  </header>

  <div class="card">
    <div class="progress-row">
      <div class="progress-label">Progress</div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill">0%</div></div>
      <div class="progress-meta"><span id="badge"></span></div>
    </div>

    <div class="timeline" id="timeline"></div>
  </div>
</div>

<div id="chatbox">
  <h2>Private Chat</h2>
  <div id="messages"></div>
  <div id="typing" class="typing"></div>
  <div id="chat-input">
    <input type="text" id="msgBox" placeholder="Type a message..."/>
    <button id="sendBtn" class="btn">Send</button>
  </div>
</div>

<script>
/* Firebase init (replace with your config) */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "ID",
  appId: "APPID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

const steps = [
  "Submit CV","Interview","Visa Processing","Ticket Booking",
  "Medical Test","Travel","Arrival","Work Start"
];

/* ===== PROGRESS SYSTEM ===== */
function loadState(){ return JSON.parse(localStorage.getItem("state")||"{}"); }
function saveState(st){ localStorage.setItem("state",JSON.stringify(st)); }

let state = loadState();
if(!state.steps) state.steps = steps.map(()=>({done:false, note:"", ts:null}));

const timeline=document.getElementById("timeline");
steps.forEach((label,i)=>{
  const s=state.steps[i];
  const div=document.createElement("div");
  div.className="step";
  div.innerHTML=`
    <div class="circle ${s.done?"done":""}" data-idx="${i}">${i+1}</div>
    <div class="vline ${s.done?"filled":""}"></div>
    <div class="step-content">
      <h3><input type="checkbox" ${s.done?"checked":""}/> ${label}</h3>
      <small>${s.ts?new Date(s.ts).toLocaleString():""}</small>
      <textarea placeholder="Notes...">${s.note||""}</textarea>
    </div>`;
  timeline.appendChild(div);
});

/* progress calc */
function updateProgress(){
  const done=state.steps.filter(s=>s.done).length;
  const pct=Math.round(done/state.steps.length*100);
  document.getElementById("progress-fill").style.width=pct+"%";
  document.getElementById("progress-fill").textContent=pct+"%";
  let badge="";
  if(pct>=100) badge="🏆 Champion";
  else if(pct>=75) badge="🔥 Achiever";
  else if(pct>=50) badge="⭐ Halfway Hero";
  else if(pct>=25) badge="🌱 Starter";
  document.getElementById("badge").textContent=badge;
  if(pct===100){confetti();}
}
updateProgress();

/* event binding */
timeline.querySelectorAll(".step").forEach((stepDiv,i)=>{
  const cb=stepDiv.querySelector("input[type=checkbox]");
  const ta=stepDiv.querySelector("textarea");
  cb.addEventListener("change",()=>{
    state.steps[i].done=cb.checked;
    state.steps[i].ts=cb.checked?Date.now():null;
    saveState(state); updateProgress();
    stepDiv.querySelector(".circle").classList.toggle("done",cb.checked);
    stepDiv.querySelector(".vline").classList.toggle("filled",cb.checked);
  });
  ta.addEventListener("input",()=>{
    state.steps[i].note=ta.value;
    saveState(state);
  });
});

/* reset */
document.getElementById("reset").onclick=()=>{
  if(confirm("Reset all progress?")){
    localStorage.removeItem("state"); location.reload();
  }
};

/* export CSV */
document.getElementById("exportCSV").onclick=()=>{
  let csv="Step,Done,Timestamp,Note\n";
  state.steps.forEach((s,i)=>csv+=`${steps[i]},${s.done},${s.ts?new Date(s.ts).toLocaleString():""},${s.note.replace(/,/g," ")}\n`);
  const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="progress.csv"; a.click();
};
/* export PDF */
document.getElementById("exportPDF").onclick=()=>{
  const { jsPDF }=window.jspdf; const doc=new jsPDF();
  doc.setFontSize(12); doc.text("Kuwait Job Progress",10,10);
  state.steps.forEach((s,i)=>{doc.text(`${i+1}. ${steps[i]}: ${s.done?"✅":"❌"} ${s.ts?new Date(s.ts).toLocaleString():""} Note:${s.note}`,10,20+i*10);});
  doc.save("progress.pdf");
};

/* theme */
const themeToggle=document.getElementById("themeToggle");
if(localStorage.getItem("theme")==="light"){document.body.classList.add("light");}
themeToggle.onclick=()=>{
  document.body.classList.toggle("light");
  localStorage.setItem("theme",document.body.classList.contains("light")?"light":"dark");
};

/* ===== CHAT ===== */
const messages=document.getElementById("messages");
const typingEl=document.getElementById("typing");
const msgBox=document.getElementById("msgBox");
const sendBtn=document.getElementById("sendBtn");
const userId="User"+Math.floor(Math.random()*1000);

db.ref("typing").on("value",snap=>{
  const t=snap.val(); if(t && t!==userId) typingEl.textContent=t+" is typing...";
  else typingEl.textContent="";
});
msgBox.addEventListener("input",()=>db.ref("typing").set(userId));
msgBox.addEventListener("blur",()=>db.ref("typing").set(null));

sendBtn.onclick=()=>{
  if(!msgBox.value.trim()) return;
  db.ref("chat").push({user:userId,text:msgBox.value,ts:Date.now()});
  msgBox.value=""; db.ref("typing").set(null);
};

db.ref("chat").on("child_added",snap=>{
  const d=snap.val();
  const div=document.createElement("div");
  div.className="msg "+(d.user===userId?"me":"other");
  div.textContent=d.text+" ("+new Date(d.ts).toLocaleTimeString()+")";
  messages.appendChild(div);
  messages.scrollTop=messages.scrollHeight;
});

/* notification */
Notification.requestPermission();
db.ref("chat").on("child_added",snap=>{
  const d=snap.val();
  if(d.user!==userId && Notification.permission==="granted"){
    new Notification("New message",{body:d.text});
  }
});
</script>
</body>
</html>
